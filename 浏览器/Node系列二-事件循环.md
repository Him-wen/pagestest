## ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªçŽ¯
äº‹ä»¶å¾ªçŽ¯æ˜¯ Node.js å¤„ç†éžé˜»å¡ž I/O æ“ä½œçš„æœºåˆ¶â€”â€”å°½ç®¡ JavaScript æ˜¯å•çº¿ç¨‹å¤„ç†çš„â€”â€”å½“æœ‰å¯èƒ½çš„æ—¶å€™ï¼Œå®ƒä»¬ä¼šæŠŠæ“ä½œè½¬ç§»åˆ°ç³»ç»Ÿå†…æ ¸ä¸­åŽ»ã€‚
æ—¢ç„¶ç›®å‰å¤§å¤šæ•°å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå®ƒä»¬å¯åœ¨åŽå°å¤„ç†å¤šç§æ“ä½œã€‚å½“å…¶ä¸­çš„ä¸€ä¸ªæ“ä½œå®Œæˆçš„æ—¶å€™ï¼Œå†…æ ¸é€šçŸ¥ Node.js å°†é€‚åˆçš„å›žè°ƒå‡½æ•°æ·»åŠ åˆ°_è½®è¯¢_é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶æœºæ‰§è¡Œã€‚æˆ‘ä»¬åœ¨æœ¬æ–‡åŽé¢ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»
## äº‹ä»¶å¾ªçŽ¯æœºåˆ¶è§£æž
å½“ Node.js å¯åŠ¨åŽï¼Œå®ƒä¼šåˆå§‹åŒ–äº‹ä»¶å¾ªçŽ¯ï¼Œå¤„ç†å·²æä¾›çš„è¾“å…¥è„šæœ¬ï¼ˆæˆ–ä¸¢å…¥[REPL](https://nodejs.org/api/repl.html#repl_repl)ï¼Œæœ¬æ–‡ä¸æ¶‰åŠåˆ°ï¼‰ï¼Œå®ƒå¯èƒ½ä¼šè°ƒç”¨ä¸€äº›å¼‚æ­¥çš„ APIã€è°ƒåº¦å®šæ—¶å™¨ï¼Œæˆ–è€…è°ƒç”¨process.nextTick()ï¼Œç„¶åŽå¼€å§‹å¤„ç†äº‹ä»¶å¾ªçŽ¯ã€‚
ä¸‹é¢çš„å›¾è¡¨å±•ç¤ºäº†äº‹ä»¶å¾ªçŽ¯æ“ä½œé¡ºåºçš„ç®€åŒ–æ¦‚è§ˆã€‚
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2932826/1618841413611-8ffec597-02b9-4492-aecd-f1544aacf091.png#clientId=u81f9fb9e-79fe-4&from=paste&height=296&id=u85e7ab84&margin=%5Bobject%20Object%5D&name=image.png&originHeight=591&originWidth=1312&originalType=binary&size=47386&status=done&style=none&taskId=u1647f05e-eced-44cd-b5c4-8bfdc7001c3&width=656)
_æ³¨æ„ï¼šæ¯ä¸ªæ¡†è¢«ç§°ä¸ºäº‹ä»¶å¾ªçŽ¯æœºåˆ¶çš„ä¸€ä¸ªé˜¶æ®µã€‚_
æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ª **FIFO é˜Ÿåˆ—**æ¥æ‰§è¡Œå›žè°ƒã€‚è™½ç„¶æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ç‰¹æ®Šçš„ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“äº‹ä»¶å¾ªçŽ¯è¿›å…¥ç»™å®šçš„é˜¶æ®µæ—¶ï¼Œå®ƒå°†**æ‰§è¡Œç‰¹å®šäºŽè¯¥é˜¶æ®µçš„ä»»ä½•æ“ä½œï¼Œç„¶åŽæ‰§è¡Œè¯¥é˜¶æ®µé˜Ÿåˆ—ä¸­çš„å›žè°ƒ**ï¼Œç›´åˆ°é˜Ÿåˆ—ç”¨å°½æˆ–æœ€å¤§å›žè°ƒæ•°å·²æ‰§è¡Œã€‚å½“è¯¥é˜Ÿåˆ—å·²ç”¨å°½æˆ–è¾¾åˆ°å›žè°ƒé™åˆ¶ï¼Œ**äº‹ä»¶å¾ªçŽ¯å°†ç§»åŠ¨åˆ°ä¸‹ä¸€é˜¶æ®µ**ï¼Œç­‰ç­‰ã€‚
ç”±äºŽè¿™äº›æ“ä½œä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½è°ƒåº¦_æ›´å¤šçš„_æ“ä½œå’Œç”±å†…æ ¸æŽ’åˆ—åœ¨**è½®è¯¢**é˜¶æ®µè¢«å¤„ç†çš„æ–°äº‹ä»¶ï¼Œ ä¸”åœ¨å¤„ç†è½®è¯¢ä¸­çš„äº‹ä»¶æ—¶ï¼Œè½®è¯¢äº‹ä»¶å¯ä»¥æŽ’é˜Ÿã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œçš„å›žè°ƒå¯ä»¥å…è®¸è½®è¯¢é˜¶æ®µè¿è¡Œé•¿äºŽè®¡æ—¶å™¨çš„é˜ˆå€¼æ—¶é—´ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[è®¡æ—¶å™¨](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#timers)å’Œ[è½®è¯¢](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#poll)éƒ¨åˆ†ã€‚
## é˜¶æ®µæ¦‚è¿°

- **å®šæ—¶å™¨timer**ï¼šæœ¬é˜¶æ®µæ‰§è¡Œå·²ç»è¢«setTimeout()å’ŒsetInterval()çš„è°ƒåº¦å›žè°ƒå‡½æ•°ã€‚
- **å¾…å®šå›žè°ƒ**ï¼šæ‰§è¡Œå»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªçŽ¯è¿­ä»£çš„ I/O å›žè°ƒã€‚
- **idle, prepare**ï¼šä»…ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ã€‚
- **è½®è¯¢poll**ï¼šæ£€ç´¢æ–°çš„ I/O äº‹ä»¶;æ‰§è¡Œä¸Ž I/O ç›¸å…³çš„å›žè°ƒï¼ˆè¿™å°±æ˜¯ä»»åŠ¡é˜Ÿåˆ—pollé‡Œé¢çš„è¦å¹²çš„äº‹ï¼‰ï¼ˆå‡ ä¹Žæ‰€æœ‰æƒ…å†µä¸‹ï¼Œé™¤äº†å…³é—­çš„å›žè°ƒå‡½æ•°ï¼Œé‚£äº›ç”±è®¡æ—¶å™¨å’ŒsetImmediate()è°ƒåº¦çš„ä¹‹å¤–ï¼‰ï¼Œå…¶ä½™æƒ…å†µ node å°†åœ¨é€‚å½“çš„æ—¶å€™åœ¨æ­¤é˜»å¡žã€‚
- **æ£€æµ‹check**ï¼šsetImmediate()å›žè°ƒå‡½æ•°åœ¨è¿™é‡Œæ‰§è¡Œã€‚
- **å…³é—­çš„å›žè°ƒå‡½æ•°**ï¼šä¸€äº›å…³é—­çš„å›žè°ƒå‡½æ•°ï¼Œå¦‚ï¼šsocket.on('close', ...)ã€‚

åœ¨æ¯æ¬¡è¿è¡Œçš„äº‹ä»¶å¾ªçŽ¯ä¹‹é—´ï¼ŒNode.js æ£€æŸ¥å®ƒæ˜¯å¦åœ¨ç­‰å¾…ä»»ä½•å¼‚æ­¥ I/O æˆ–è®¡æ—¶å™¨ï¼Œå¦‚æžœæ²¡æœ‰çš„è¯ï¼Œåˆ™å®Œå…¨å…³é—­ã€‚
æˆ‘ä»¬é‡ç‚¹çœ‹**timersã€pollã€check**è¿™3ä¸ªé˜¶æ®µå°±å¥½ï¼Œå› ä¸ºæ—¥å¸¸å¼€å‘ä¸­çš„ç»å¤§éƒ¨åˆ†å¼‚æ­¥ä»»åŠ¡éƒ½æ˜¯åœ¨è¿™3ä¸ªé˜¶æ®µå¤„ç†çš„ã€‚


### å®šæ—¶å™¨timers
è®¡æ—¶å™¨æŒ‡å®š_å¯ä»¥æ‰§è¡Œæ‰€æä¾›å›žè°ƒ_çš„**é˜ˆå€¼**ï¼Œè€Œä¸æ˜¯ç”¨æˆ·å¸Œæœ›å…¶æ‰§è¡Œçš„ç¡®åˆ‡æ—¶é—´ã€‚åœ¨æŒ‡å®šçš„ä¸€æ®µæ—¶é—´é—´éš”åŽï¼Œ è®¡æ—¶å™¨å›žè°ƒå°†è¢«å°½å¯èƒ½æ—©åœ°è¿è¡Œã€‚ä½†æ˜¯ï¼Œæ“ä½œç³»ç»Ÿè°ƒåº¦æˆ–å…¶å®ƒæ­£åœ¨è¿è¡Œçš„å›žè°ƒå¯èƒ½ä¼šå»¶è¿Ÿå®ƒä»¬ã€‚
timers æ˜¯äº‹ä»¶å¾ªçŽ¯çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼ŒNode ä¼šåŽ»æ£€æŸ¥æœ‰æ— å·²è¿‡æœŸçš„**timer**ï¼Œ
1.å¦‚æžœæœ‰åˆ™æŠŠå®ƒçš„å›žè°ƒ**åŽ‹å…¥timerçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­**ç­‰å¾…æ‰§è¡Œï¼ˆå¦‚æžœé˜Ÿåˆ—é‡Œé¢æœ‰å¯æ‰§è¡Œçš„å®šæ—¶å™¨ï¼Œç„¶åŽå°±ä¼šä¸€ä¸€å¼¹å‡ºæ¥æ‰§è¡Œï¼Œè¿™é‡Œæ˜¯ç›´æŽ¥æ‰§è¡Œäº†ï¼Œç„¶åŽåœ¨é˜Ÿåˆ—éƒ½æ¸…ç©ºäº†ï¼Œ  
å…³äºŽå¾®ä»»åŠ¡çš„å¤„ç†ï¼šnode11ä¹‹å‰ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µä¹‹å‰ï¼Œå°†å¤šä¸ªå®ä»»åŠ¡ï¼ˆä¹Ÿå°±æ˜¯å®šæ—¶å™¨é‡Œé¢äº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼‰ ç»™æ¸…ç©ºï¼Œç›¸å½“äºŽå¤šä¸ªå®ä»»åŠ¡å¯¹åº”ä¸€ä¸ªå¾®ä»»åŠ¡ï¼‰ï¼Œåˆ°äº†node11ä¹‹åŽï¼Œå°±ç›´æŽ¥ä¿æŒäº†å’Œæµè§ˆå™¨çš„é¡ºåºä¸€è‡´ï¼Œ  
å…¶ä¸­å¾®ä»»åŠ¡æœ‰äºŒç§ï¼šä¸€ç§æ˜¯nexttickå¾®ä»»åŠ¡ï¼Œä¸€ç§æ˜¯promiseäº§ç”Ÿçš„

2ã€‚äº‹å®žä¸Šï¼ŒNode å¹¶ä¸èƒ½ä¿è¯timeråœ¨é¢„è®¾æ—¶é—´åˆ°äº†å°±ä¼šç«‹å³æ‰§è¡Œï¼Œå› ä¸ºNodeå¯¹timerçš„è¿‡æœŸæ£€æŸ¥ä¸ä¸€å®šé è°±ï¼Œå®ƒä¼šå—æœºå™¨ä¸Šå…¶å®ƒè¿è¡Œç¨‹åºå½±å“ï¼Œæˆ–è€…é‚£ä¸ªæ—¶é—´ç‚¹ä¸»çº¿ç¨‹ä¸ç©ºé—²ã€‚
3.æ²¡æœ‰çš„è¯ç›´æŽ¥åˆ°è½®è¯¢é˜¶æ®µ


æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œ**setTimeout**()å’Œ**setImmediate**()çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚
#### setImmediate()å¯¹æ¯”setTimeout()
setImmediate()å’ŒsetTimeout()å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯åŸºäºŽè¢«è°ƒç”¨çš„æ—¶æœºï¼Œä»–ä»¬ä¹Ÿæœ‰ä¸åŒè¡¨çŽ°ã€‚

- setImmediate()è®¾è®¡ä¸ºä¸€æ—¦åœ¨å½“å‰**è½®è¯¢**é˜¶æ®µå®Œæˆï¼Œ å°±æ‰§è¡Œè„šæœ¬ã€‚
- setTimeout()åœ¨æœ€å°é˜ˆå€¼ï¼ˆms å•ä½ï¼‰è¿‡åŽè¿è¡Œè„šæœ¬ã€‚
```javascript
setTimeout(() => {
  console.log('timeout')
}, 0)

setImmediate(() => {
  console.log('immediate')
```
ä½†æ˜¯æŠŠå®ƒä»¬æ”¾åˆ°ä¸€ä¸ªI/Oå›žè°ƒé‡Œé¢ï¼Œå°±ä¸€å®šæ˜¯setImmediate()å…ˆæ‰§è¡Œï¼Œå› ä¸ºpollé˜¶æ®µåŽé¢å°±æ˜¯checké˜¶æ®µã€‚
ä¼˜åŠ¿ï¼šä½¿ç”¨setImmediate()ç›¸å¯¹äºŽsetTimeout()çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼Œå¦‚æžœsetImmediate()æ˜¯åœ¨ I/O å‘¨æœŸå†…è¢«è°ƒåº¦çš„ï¼Œé‚£å®ƒå°†ä¼šåœ¨å…¶ä¸­ä»»ä½•çš„å®šæ—¶å™¨ä¹‹å‰æ‰§è¡Œï¼Œè·Ÿè¿™é‡Œå­˜åœ¨å¤šå°‘ä¸ªå®šæ—¶å™¨æ— å…³
æ³¨æ„ï¼š[è½®è¯¢é˜¶æ®µ](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#poll)æŽ§åˆ¶ä½•æ—¶å®šæ—¶å™¨æ‰§è¡Œã€‚
ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨è°ƒåº¦äº†ä¸€ä¸ªåœ¨ 100 æ¯«ç§’åŽè¶…æ—¶çš„å®šæ—¶å™¨ï¼Œç„¶åŽæ‚¨çš„è„šæœ¬å¼€å§‹å¼‚æ­¥è¯»å–ä¼šè€—è´¹ 95 æ¯«ç§’çš„æ–‡ä»¶:
```javascript
const fs = require('fs');

function someAsyncOperation(callback) {
  // Assume this takes 95ms to complete
  fs.readFile('/path/to/file', callback);
}

const timeoutScheduled = Date.now();

setTimeout(() => {
  const delay = Date.now() - timeoutScheduled;

  console.log(`${delay}ms have passed since I was scheduled`);
}, 100);

// do someAsyncOperation which takes 95 ms to complete
someAsyncOperation(() => {
  const startCallback = Date.now();

  // do something that will take 10ms...
  while (Date.now() - startCallback < 10) {
    // do nothing
  }
});
```
å½“äº‹ä»¶å¾ªçŽ¯è¿›å…¥**è½®è¯¢**é˜¶æ®µæ—¶ï¼Œå®ƒæœ‰ä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼ˆæ­¤æ—¶fs.readFile()å°šæœªå®Œæˆï¼‰ï¼Œå› æ­¤å®ƒå°†ç­‰å¾…å‰©ä¸‹çš„æ¯«ç§’æ•°ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¿«çš„ä¸€ä¸ªè®¡æ—¶å™¨é˜ˆå€¼ä¸ºæ­¢ã€‚
1.å½“å®ƒç­‰å¾… 95 æ¯«ç§’è¿‡åŽæ—¶ï¼Œfs.readFile()å®Œæˆè¯»å–æ–‡ä»¶ï¼Œ
2.å®ƒçš„é‚£ä¸ªéœ€è¦ 10 æ¯«ç§’æ‰èƒ½å®Œæˆçš„å›žè°ƒï¼ˆè¿™ä¸ªæ˜¯æ–‡ä»¶æ“ä½œé‡Œé¢çš„å‡½æ•° å±žäºŽIOäº‹ä»¶ï¼‰ï¼Œå°†è¢«æ·»åŠ åˆ°**è½®è¯¢**é˜Ÿåˆ—ä¸­å¹¶æ‰§è¡Œã€‚
3.å½“å›žè°ƒå®Œæˆæ—¶ï¼Œé˜Ÿåˆ—ä¸­ä¸å†æœ‰å›žè°ƒï¼Œå› æ­¤äº‹ä»¶å¾ªçŽ¯æœºåˆ¶å°†**æŸ¥çœ‹**æœ€å¿«åˆ°è¾¾é˜ˆå€¼çš„è®¡æ—¶å™¨ï¼Œç„¶åŽå°†å›žåˆ°**è®¡æ—¶å™¨timer**é˜¶æ®µï¼Œä»¥æ‰§è¡Œå®šæ—¶å™¨çš„å›žè°ƒã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°è°ƒåº¦è®¡æ—¶å™¨åˆ°å®ƒçš„å›žè°ƒè¢«æ‰§è¡Œä¹‹é—´çš„æ€»å»¶è¿Ÿå°†ä¸º 105 æ¯«ç§’ã€‚
**æ³¨æ„**ï¼šä¸ºäº†é˜²æ­¢**è½®è¯¢**é˜¶æ®µé¥¿æ­»äº‹ä»¶å¾ªçŽ¯ï¼Œ[libuv](https://libuv.org/)ï¼ˆå®žçŽ° Node.js äº‹ä»¶å¾ªçŽ¯å’Œå¹³å°çš„æ‰€æœ‰å¼‚æ­¥è¡Œä¸ºçš„ C å‡½æ•°åº“ï¼‰ï¼Œåœ¨åœæ­¢è½®è¯¢ä»¥èŽ·å¾—æ›´å¤šäº‹ä»¶ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªç¡¬æ€§æœ€å¤§å€¼ï¼ˆä¾èµ–äºŽç³»ç»Ÿï¼‰ã€‚


### è½®è¯¢é˜¶æ®µ
![image](https://user-images.githubusercontent.com/24501320/118353554-64298b00-b599-11eb-96ae-3adf0bda3bad.png)

**è½®è¯¢**é˜¶æ®µæœ‰ä¸¤ä¸ªé‡è¦çš„åŠŸèƒ½ï¼š

1. è®¡ç®—åº”è¯¥é˜»å¡žå’Œè½®è¯¢ I/O çš„æ—¶é—´ã€‚ï¼ˆ**å½“æœ‰å·²è¶…æ—¶çš„ timerï¼Œæ‰§è¡Œå®ƒçš„å›žè°ƒå‡½æ•°**ï¼‰
1. ç„¶åŽï¼Œå¤„ç†poll**è½®è¯¢**é˜Ÿåˆ—é‡Œçš„äº‹ä»¶ã€‚

å½“äº‹ä»¶å¾ªçŽ¯è¿›å…¥**è½®è¯¢poll**é˜¶æ®µä¸”_æ²¡æœ‰è¢«è°ƒåº¦çš„è®¡æ—¶å™¨æ—¶_ï¼Œå°†å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼š

- _å¦‚æžœ**è½®è¯¢**é˜Ÿåˆ—**ä¸æ˜¯ç©ºçš„**_ï¼Œäº‹ä»¶å¾ªçŽ¯å°†å¾ªçŽ¯è®¿é—®å›žè°ƒé˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œå®ƒä»¬ï¼Œç›´åˆ°é˜Ÿåˆ—å·²ç”¨å°½ï¼Œæˆ–è€…è¾¾åˆ°äº†ä¸Žç³»ç»Ÿç›¸å…³çš„ç¡¬æ€§é™åˆ¶ã€‚
- _å¦‚æžœ**è½®è¯¢**é˜Ÿåˆ—**æ˜¯ç©ºçš„**_ï¼Œè¿˜æœ‰ä¸¤ä»¶äº‹å‘ç”Ÿï¼š
   - å¦‚æžœè„šæœ¬è¢«setImmediate()è°ƒåº¦ï¼Œåˆ™äº‹ä»¶å¾ªçŽ¯å°†ç»“æŸ**è½®è¯¢poll**é˜¶æ®µï¼Œå¹¶ç»§ç»­**æ£€æŸ¥check**é˜¶æ®µä»¥æ‰§è¡Œé‚£äº›è¢«è°ƒåº¦çš„è„šæœ¬ã€‚
   - å¦‚æžœè„šæœ¬**æœªè¢«**setImmediate()è°ƒåº¦ï¼Œåˆ™äº‹ä»¶å¾ªçŽ¯å°†**ç­‰å¾…å›žè°ƒ**è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åŽç«‹å³æ‰§è¡Œã€‚

ä¸€æ—¦**è½®è¯¢**é˜Ÿåˆ—ä¸ºç©ºï¼Œäº‹ä»¶å¾ªçŽ¯å°†æ£€æŸ¥ _å·²è¾¾åˆ°æ—¶é—´é˜ˆå€¼çš„è®¡æ—¶å™¨_ã€‚å¦‚æžœä¸€ä¸ªæˆ–å¤šä¸ªè®¡æ—¶å™¨å·²å‡†å¤‡å°±ç»ªï¼Œåˆ™äº‹ä»¶å¾ªçŽ¯å°†ç»•å›žè®¡æ—¶å™¨é˜¶æ®µä»¥æ‰§è¡Œè¿™äº›è®¡æ—¶å™¨çš„å›žè°ƒã€‚


âš ï¸ï¼š**æ³¨æ„ä¸€ä¸ªç»†èŠ‚**ï¼Œæ²¡æœ‰setImmediate()ä¼šå¯¼è‡´event loopé˜»å¡žåœ¨pollé˜¶æ®µï¼Œè¿™æ ·ä¹‹å‰è®¾ç½®çš„timerå²‚ä¸æ˜¯æ‰§è¡Œä¸äº†äº†ï¼Ÿæ‰€ä»¥å’§ï¼Œåœ¨pollé˜¶æ®µevent loopä¼šæœ‰ä¸€ä¸ªæ£€æŸ¥æœºåˆ¶ï¼Œæ£€æŸ¥timeré˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æžœtimeré˜Ÿåˆ—éžç©ºï¼Œevent loopå°±å¼€å§‹ä¸‹ä¸€è½®äº‹ä»¶å¾ªçŽ¯ï¼Œå³é‡æ–°è¿›å…¥åˆ°timeré˜¶æ®µã€‚

**ç–‘é—®ðŸ¤”ï¸**ï¼ševent loop å°±æ˜¯poll é‡Œé¢ä¸€æ–¹é¢è½®å¾ªç­‰å¾… æ–°ioå›žè°ƒ å¦ä¸€æ–¹é¢æ£€æŸ¥timeré˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æžœä¸ä¸ºç©ºå°±ç›´æŽ¥ç»“æŸæœ¬é˜¶æ®µï¼Œé‚£ä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»å—ï¼Ÿä¼˜å…ˆçº§æ–¹é¢ä¹‹å†…çš„ï¼ŒæŒ‰å®˜ç½‘çš„è¯´æ³•ï¼Œçœ‹è¿™ä¸ªé€»è¾‘å¥½åƒæ˜¯ åªè¦timerä¸ä¸ºç©ºå°±ç›´æŽ¥ ç»“æŸæœ¬é˜¶æ®µäº†ã€‚ã€‚ioå›žè°ƒäº‹ä»¶ç­‰ä¸‹ä¸€å¾ªçŽ¯

### æ£€æŸ¥é˜¶æ®µ
æ­¤é˜¶æ®µå…è®¸äººå‘˜åœ¨è½®è¯¢é˜¶æ®µå®ŒæˆåŽç«‹å³æ‰§è¡Œå›žè°ƒã€‚å¦‚æžœè½®è¯¢é˜¶æ®µå˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¹¶ä¸”è„šæœ¬ä½¿ç”¨setImmediate()åŽè¢«æŽ’åˆ—åœ¨é˜Ÿåˆ—ä¸­ï¼Œåˆ™äº‹ä»¶å¾ªçŽ¯å¯èƒ½ç»§ç»­åˆ°**æ£€æŸ¥**é˜¶æ®µè€Œä¸æ˜¯ç­‰å¾…ã€‚
setImmediate()å®žé™…ä¸Šæ˜¯ä¸€ä¸ªåœ¨äº‹ä»¶å¾ªçŽ¯çš„å•ç‹¬é˜¶æ®µè¿è¡Œçš„ç‰¹æ®Šè®¡æ—¶å™¨ã€‚å®ƒä½¿ç”¨ä¸€ä¸ª libuv API æ¥å®‰æŽ’å›žè°ƒåœ¨**è½®è¯¢**é˜¶æ®µå®ŒæˆåŽæ‰§è¡Œã€‚
é€šå¸¸ï¼Œåœ¨æ‰§è¡Œä»£ç æ—¶ï¼Œäº‹ä»¶å¾ªçŽ¯æœ€ç»ˆä¼šå‘½ä¸­**è½®è¯¢é˜¶æ®µ**ï¼Œåœ¨é‚£ç­‰å¾…ä¼ å…¥è¿žæŽ¥ã€è¯·æ±‚ç­‰ã€‚ä½†æ˜¯ï¼Œå¦‚æžœå›žè°ƒå·²ä½¿ç”¨setImmediate()è°ƒåº¦è¿‡ï¼Œå¹¶ä¸”è½®è¯¢é˜¶æ®µå˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œåˆ™å®ƒå°†ç»“æŸæ­¤é˜¶æ®µï¼Œå¹¶ç»§ç»­åˆ°æ£€æŸ¥checké˜¶æ®µè€Œä¸æ˜¯ç»§ç»­ç­‰å¾…è½®è¯¢äº‹ä»¶ã€‚


#### process.nextTick()å¯¹æ¯”setImmediate()
å°±ç”¨æˆ·è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç±»ä¼¼çš„è°ƒç”¨ï¼Œä½†å®ƒä»¬çš„åç§°ä»¤äººè´¹è§£ã€‚

- process.nextTick()åœ¨**åŒä¸€ä¸ªé˜¶æ®µç«‹å³**æ‰§è¡Œã€‚
- setImmediate()åœ¨äº‹ä»¶å¾ªçŽ¯çš„**æŽ¥ä¸‹æ¥çš„è¿­ä»£æˆ– 'tick' ä¸Š**è§¦å‘ã€‚

å®žè´¨ä¸Šï¼Œè¿™ä¸¤ä¸ªåç§°åº”è¯¥äº¤æ¢ï¼Œå› ä¸ºprocess.nextTick()æ¯”setImmediate()è§¦å‘å¾—æ›´å¿«ï¼Œä½†è¿™æ˜¯è¿‡åŽ»é—ç•™é—®é¢˜ï¼Œå› æ­¤ä¸å¤ªå¯èƒ½æ”¹å˜ã€‚å¦‚æžœè´¸ç„¶è¿›è¡Œåç§°äº¤æ¢ï¼Œå°†ç ´å npm ä¸Šçš„å¤§éƒ¨åˆ†è½¯ä»¶åŒ…ã€‚æ¯å¤©éƒ½æœ‰æ›´å¤šæ–°çš„æ¨¡å—åœ¨å¢žåŠ ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¦å¤šç­‰å¾…æ¯ä¸€å¤©ï¼Œåˆ™æ›´å¤šæ½œåœ¨ç ´åä¼šå‘ç”Ÿã€‚å°½ç®¡è¿™äº›åç§°ä½¿äººæ„Ÿåˆ°å›°æƒ‘ï¼Œä½†å®ƒä»¬æœ¬èº«åå­—ä¸ä¼šæ”¹å˜ã€‚
process.nextTick()ä¼šåœ¨å„ä¸ªäº‹ä»¶é˜¶æ®µä¹‹é—´æ‰§è¡Œï¼Œä¸€æ—¦æ‰§è¡Œï¼Œè¦ç›´åˆ°nextTické˜Ÿåˆ—è¢«æ¸…ç©ºï¼Œæ‰ä¼šè¿›å…¥åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶é˜¶æ®µï¼Œæ‰€ä»¥å¦‚æžœé€’å½’è°ƒç”¨process.nextTick()ï¼Œä¼šå¯¼è‡´å‡ºçŽ°I/O starvingï¼ˆé¥¥é¥¿ï¼‰çš„é—®é¢˜
_æˆ‘ä»¬å»ºè®®å¼€å‘äººå‘˜åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä½¿ç”¨setImmediate()ï¼Œå› ä¸ºå®ƒæ›´å®¹æ˜“ç†è§£ã€‚_
## å°ç»“

- event loop çš„æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—
- å½“ event loop åˆ°è¾¾æŸä¸ªé˜¶æ®µæ—¶ï¼Œå°†æ‰§è¡Œè¯¥é˜¶æ®µçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç›´åˆ°é˜Ÿåˆ—æ¸…ç©ºæˆ–æ‰§è¡Œçš„å›žè°ƒè¾¾åˆ°ç³»ç»Ÿä¸Šé™åŽï¼Œæ‰ä¼šè½¬å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ
- å½“æ‰€æœ‰é˜¶æ®µè¢«é¡ºåºæ‰§è¡Œä¸€æ¬¡åŽï¼Œç§° event loop å®Œæˆäº†ä¸€ä¸ª tick
## Node.js ä¸Žæµè§ˆå™¨çš„ Event Loop å·®å¼‚
å›žé¡¾ä¸Šä¸€ç¯‡ï¼Œæµè§ˆå™¨çŽ¯å¢ƒä¸‹ï¼Œmicrotaskçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ¯ä¸ªmacrotaskæ‰§è¡Œå®Œä¹‹åŽæ‰§è¡Œã€‚
![](https://cdn.nlark.com/yuque/0/2021/png/2932826/1618844212178-eb918f55-26a4-4737-9a7b-eafefb3231a8.png#clientId=u81f9fb9e-79fe-4&from=paste&height=339&id=u22a9afad&margin=%5Bobject%20Object%5D&originHeight=414&originWidth=810&originalType=url&status=done&style=none&taskId=u375d34cf-5d57-4e5a-91bf-3a3e2e40b4f&width=663)
è€Œåœ¨Node.jsä¸­ï¼Œmicrotaskä¼šåœ¨äº‹ä»¶å¾ªçŽ¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œå°±ä¼šåŽ»æ‰§è¡Œmicrotaské˜Ÿåˆ—çš„ä»»åŠ¡ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2932826/1618844224481-f3527ef1-966a-4e62-99a6-12ebc6cdf111.png#clientId=u81f9fb9e-79fe-4&from=paste&height=503&id=u98636ace&margin=%5Bobject%20Object%5D&name=image.png&originHeight=503&originWidth=655&originalType=binary&size=28129&status=done&style=none&taskId=u5b36b14c-164b-4181-aa36-f74bae7f10c&width=655)
å‚è€ƒèµ„æ–™ï¼š
[https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/)
[http://lynnelv.github.io/js-event-loop-nodejs](http://lynnelv.github.io/js-event-loop-nodejs)
