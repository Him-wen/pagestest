# 什么是 XSS 攻击？
XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。
`XSS` 全称是 `Cross Site Scripting`(即`跨站脚本`)，为了和 CSS 区分，故叫它`XSS`。XSS 攻击是指浏览器中执行恶意脚本(无论是跨域还是同域)，从而拿到用户的信息并进行操作。
这些操作一般可以完成下面这些事情:

1. 窃取`Cookie`。
1. 监听用户行为，比如输入账号密码后直接发送到黑客服务器。
1. 修改 DOM 伪造登录表单。
1. 在页面中生成浮窗广告。

通常情况，XSS 攻击的实现有三种方式——**存储型**、**反射型**和**文档型**。原理都比较简单，先来一一介绍一下。
## 👣存储型
`存储型`，顾名思义就是将恶意脚本存储了起来，确实，存储型的 XSS 将脚本存储到了服务端的数据库，然后在客户端执行这些脚本，从而达到攻击的效果。
常见的场景是留言评论区提交一段脚本代码，如果前后端没有做好转义的工作，那评论内容存到了数据库，在页面渲染过程中`直接执行`, 相当于执行一段未知逻辑的 JS 代码，是非常恐怖的。这就是存储型的 XSS 攻击。
## 👣反射型
`反射型XSS`指的是恶意脚本作为**网络请求的一部分**。
比如我输入:
```
http://sanyuan.com?q=<script>alert("你完蛋了")</script>
```
1
这样，在服务器端会拿到`q`参数,然后将内容返回给浏览器端，浏览器将这些内容作为HTML的一部分解析，发现是一个脚本，直接执行，这样就被攻击了。
之所以叫它`反射型`, 是因为恶意脚本是通过作为网络请求的参数，经过服务器，然后再反射到HTML文档中，执行解析。和`存储型`不一样的是，服务器并不会存储这些恶意脚本。
### 攻击步骤

1. 攻击者构造出特殊的 URL，其中包含恶意代码
1. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器
1. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行
1. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作
```javascript
<div id="root"></div>
<script type="application/javascript">
  // 假设这是请求返回的数据
  const res = ['1', '2', '3', '<img src="1" onerror="console.log(windwo.localStorage)" />'];
  const root = document.querySelector('#root');
  res.forEach(item => {
    const p = document.createElement('p');
    p.innerHTML = item;
    root.append(p);
  });
</script>
当数据返回后，img 标签会注入 HTML DOM 文档中，又因为 src 属性为无效的 URL 值，所以触发了 onerror 事件，从而执行了 onerror 定义的函数，这样便获取到了存储在客户端本地的 localStorage 信息。
```
当数据返回后，`img` 标签会注入 HTML DOM 文档中，又因为 `src` 属性为无效的 URL 值，所以触发了 `onerror` 事件，从而执行了 `onerror` 定义的函数，这样便获取到了存储在客户端本地的 `localStorage` 信息。
### 反射型 XSS 跟存储型 XSS 的区别是？
存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。
反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。
由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。
## 👣文档型
文档型的 XSS 攻击并不会经过服务端，而是作为中间人的角色，在数据传输过程劫持到网络数据包，然后**修改里面的 html 文档**！
这样的劫持方式包括`WIFI路由器劫持`或者`本地恶意软件`等。
## 👣防范措施
明白了三种`XSS`攻击的原理，我们能发现一个共同点: 都是让恶意脚本直接能在浏览器中执行。
那么要防范它，就是要避免这些脚本代码的执行。
为了完成这一点，必须做到**一个信念，两个利用**。
### 一个信念
千万不要相信任何用户的输入！
无论是在前端和服务端，都要对用户的输入进行**转码**或者**过滤**。
如:
```javascript
<script>alert('你完蛋了')</script>
```
1
转码后变为:
```javascript
&lt;script&gt;alert(&#39;你完蛋了&#39;)&lt;/script&gt;
```
1
这样的代码在 html 解析的过程中是无法执行的。
当然也可以利用关键词过滤的方式，将 script 标签给删除。那么现在的内容只剩下:
什么也没有了:）
### 利用 CSP
CSP，即浏览器中的内容安全策略，它的核心思想就是服务器决定浏览器加载哪些资源，具体来说可以完成以下功能:

1. 限制其他域下的资源加载。
1. 禁止向其它域提交数据。
1. 提供上报机制，能帮助我们及时发现 XSS 攻击。
### 利用 HttpOnly
很多 XSS 攻击脚本都是用来窃取Cookie, 而设置 Cookie 的 HttpOnly 属性后，JavaScript 便无法读取 Cookie 的值。这样也能很好的防范 XSS 攻击。
## 总结
`XSS` 攻击是指浏览器中执行恶意脚本, 然后拿到用户的信息进行操作。主要分为`存储型`、`反射型`和`文档型`。防范的措施包括:

- 一个信念: 不要相信用户的输入，对输入内容转码或者过滤，让其不可执行。
- 两个利用: 利用 CSP，利用 Cookie 的 HttpOnly 属性。
